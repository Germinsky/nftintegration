<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Prophets NFT - Standalone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(to bottom, #f8f9fa, #ffffff);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .wallet-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .connect-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .connect-button:hover {
            transform: translateY(-2px);
        }

        .connect-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .wallet-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
        }

        .mint-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .mint-section h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .requirements {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .requirements ul {
            list-style: none;
        }

        .requirements li {
            padding: 8px 0;
            font-size: 1rem;
        }

        .requirements li.check::before {
            content: '‚úÖ ';
        }

        .requirements li.cross::before {
            content: '‚ùå ';
        }

        .mint-button {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .mint-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .mint-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .mint-button.success {
            background: #4caf50;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .nft-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .nft-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .nft-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .nft-info {
            padding: 20px;
        }

        .nft-info h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .nft-info p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .nft-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .nft-id {
            color: #999;
            font-size: 0.85rem;
        }

        .nft-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .nft-link:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 1rem;
            }

            .gallery-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Digital Prophets NFT Collection</h1>
            <p>Mint exclusive music NFTs and showcase your collection on Base</p>
        </div>

        <!-- Wallet Connection -->
        <div class="wallet-section">
            <h2>Connect Your Wallet</h2>
            <button id="connectBtn" class="connect-button">Connect Wallet</button>
            <div id="walletInfo" class="wallet-info" style="display: none;"></div>
        </div>

        <!-- Mint Section -->
        <div class="mint-section">
            <h2>Mint Your NFT</h2>
            
            <div class="requirements">
                <h3>Requirements:</h3>
                <ul id="requirementsList">
                    <li class="cross" id="req-wallet">Connect your wallet</li>
                    <li class="cross" id="req-network">Switch to Base network</li>
                    <li class="cross" id="req-proph">Hold at least 100 PROPH tokens</li>
                </ul>
            </div>

            <button id="mintBtn" class="mint-button" disabled>
                üéµ Mint NFT (Free)
            </button>

            <div id="mintStatus"></div>
        </div>

        <!-- NFT Gallery -->
        <div id="gallery" class="gallery-section">
            <h2 style="text-align: center; margin-bottom: 20px;">Your NFT Collection</h2>
            <div id="galleryGrid" class="gallery-grid"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Configuration
        const NFT_CONTRACT = '0xd8CfC327B23fBcdEe12802bA6cA97e1e7786bF47';
        const PROPH_TOKEN = '0x1890E4f2668b98170B618bA45Bc1B5721ACf9575';
        const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
        const MIN_PROPH_BALANCE = ethers.utils.parseEther('100');

        // ABIs
        const NFT_ABI = [
            'function mint(address to) public payable',
            'function totalSupply() public view returns (uint256)',
            'function balanceOf(address owner) public view returns (uint256)',
            'function tokenOfOwnerByIndex(address owner, uint256 index) public view returns (uint256)',
            'function tokenURI(uint256 tokenId) public view returns (string)',
        ];

        const ERC20_ABI = [
            'function balanceOf(address account) public view returns (uint256)',
        ];

        // State
        let provider = null;
        let signer = null;
        let userAddress = null;

        // Elements
        const connectBtn = document.getElementById('connectBtn');
        const walletInfo = document.getElementById('walletInfo');
        const mintBtn = document.getElementById('mintBtn');
        const mintStatus = document.getElementById('mintStatus');
        const galleryGrid = document.getElementById('galleryGrid');

        // Connect Wallet
        connectBtn.addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet!');
                return;
            }

            try {
                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Update UI
                walletInfo.style.display = 'block';
                walletInfo.innerHTML = `
                    <strong>Connected:</strong> ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}<br>
                    <button onclick="disconnectWallet()" style="margin-top: 10px; padding: 8px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">Disconnect</button>
                `;
                connectBtn.disabled = true;
                connectBtn.textContent = 'Connected ‚úì';

                updateRequirement('req-wallet', true);

                // Check network
                await checkNetwork();

                // Check balances
                await checkBalances();

                // Load gallery
                await loadGallery();

            } catch (error) {
                console.error('Connection error:', error);
                showStatus('Failed to connect wallet', 'error');
            }
        });

        // Check Network
        async function checkNetwork() {
            const network = await provider.getNetwork();
            const isBase = network.chainId === 8453;

            if (!isBase) {
                updateRequirement('req-network', false);
                
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BASE_CHAIN_ID }],
                    });
                    updateRequirement('req-network', true);
                } catch (error) {
                    if (error.code === 4902) {
                        // Chain not added, add it
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: BASE_CHAIN_ID,
                                    chainName: 'Base',
                                    nativeCurrency: { name: 'Ethereum', symbol: 'ETH', decimals: 18 },
                                    rpcUrls: ['https://mainnet.base.org'],
                                    blockExplorerUrls: ['https://basescan.org'],
                                }],
                            });
                            updateRequirement('req-network', true);
                        } catch (addError) {
                            showStatus('Failed to add Base network', 'error');
                        }
                    } else {
                        showStatus('Please switch to Base network', 'error');
                    }
                }
            } else {
                updateRequirement('req-network', true);
            }
        }

        // Check Balances
        async function checkBalances() {
            try {
                const prophContract = new ethers.Contract(PROPH_TOKEN, ERC20_ABI, provider);
                const balance = await prophContract.balanceOf(userAddress);
                
                const hasEnough = balance.gte(MIN_PROPH_BALANCE);
                updateRequirement('req-proph', hasEnough);

                if (hasEnough) {
                    mintBtn.disabled = false;
                    mintBtn.textContent = 'üéµ Mint NFT (Free)';
                } else {
                    mintBtn.disabled = true;
                    const current = ethers.utils.formatEther(balance);
                    mintBtn.textContent = `Need more PROPH (Have: ${parseFloat(current).toFixed(2)})`;
                }
            } catch (error) {
                console.error('Balance check error:', error);
                showStatus('Failed to check PROPH balance', 'error');
            }
        }

        // Mint NFT
        mintBtn.addEventListener('click', async () => {
            if (!signer) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                mintBtn.disabled = true;
                mintBtn.textContent = 'Minting... ‚è≥';
                showStatus('Preparing transaction...', 'info');

                const nftContract = new ethers.Contract(NFT_CONTRACT, NFT_ABI, signer);
                
                // Estimate gas
                const gasEstimate = await nftContract.estimateGas.mint(userAddress);
                
                // Send transaction
                const tx = await nftContract.mint(userAddress, {
                    gasLimit: gasEstimate.mul(120).div(100), // 20% buffer
                });

                showStatus('Transaction submitted! Waiting for confirmation...', 'info');
                mintBtn.textContent = 'Confirming... ‚è≥';

                // Wait for confirmation
                const receipt = await tx.wait();

                showStatus(`
                    ‚úÖ Successfully minted NFT!<br>
                    <a href="https://basescan.org/tx/${receipt.transactionHash}" target="_blank" style="color: #155724; text-decoration: underline;">
                        View on BaseScan
                    </a>
                `, 'success');

                mintBtn.textContent = '‚úÖ Minted!';
                mintBtn.classList.add('success');

                // Reload gallery
                setTimeout(() => loadGallery(), 3000);

            } catch (error) {
                console.error('Mint error:', error);
                
                let errorMsg = 'Failed to mint NFT';
                if (error.message.includes('user rejected')) {
                    errorMsg = 'Transaction rejected by user';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg = 'Insufficient ETH for gas fees';
                }

                showStatus(errorMsg, 'error');
                mintBtn.disabled = false;
                mintBtn.textContent = 'üéµ Mint NFT (Free)';
            }
        });

        // Load NFT Gallery
        async function loadGallery() {
            if (!provider || !userAddress) {
                galleryGrid.innerHTML = '<div class="empty-state"><p>Connect wallet to view your NFTs</p></div>';
                return;
            }

            try {
                galleryGrid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading your NFTs...</p></div>';

                const nftContract = new ethers.Contract(NFT_CONTRACT, NFT_ABI, provider);
                const balance = await nftContract.balanceOf(userAddress);

                if (balance.eq(0)) {
                    galleryGrid.innerHTML = `
                        <div class="empty-state">
                            <h3>No NFTs Yet</h3>
                            <p>Mint your first Digital Prophets NFT above!</p>
                        </div>
                    `;
                    return;
                }

                const nfts = [];
                const limit = Math.min(balance.toNumber(), 12);

                for (let i = 0; i < limit; i++) {
                    try {
                        const tokenId = await nftContract.tokenOfOwnerByIndex(userAddress, i);
                        const tokenURI = await nftContract.tokenURI(tokenId);
                        
                        // Fetch metadata
                        let metadata = {
                            name: `Digital Prophets NFT #${tokenId}`,
                            description: 'A Digital Prophets music NFT',
                            image: `https://api.dicebear.com/7.x/shapes/svg?seed=${tokenId}`,
                        };

                        if (tokenURI.startsWith('http')) {
                            try {
                                const response = await fetch(tokenURI.replace('ipfs://', 'https://ipfs.io/ipfs/'));
                                metadata = await response.json();
                            } catch (e) {
                                console.error('Metadata fetch error:', e);
                            }
                        }

                        nfts.push({ tokenId: tokenId.toString(), ...metadata });
                    } catch (error) {
                        console.error(`Error loading NFT ${i}:`, error);
                    }
                }

                // Render NFTs
                galleryGrid.innerHTML = nfts.map(nft => `
                    <div class="nft-card">
                        <img 
                            src="${nft.image?.replace('ipfs://', 'https://ipfs.io/ipfs/') || nft.image}" 
                            alt="${nft.name}"
                            class="nft-image"
                            onerror="this.src='https://api.dicebear.com/7.x/shapes/svg?seed=${nft.tokenId}'"
                        >
                        <div class="nft-info">
                            <h3>${nft.name}</h3>
                            <p>${nft.description?.slice(0, 100) || ''}</p>
                            <div class="nft-footer">
                                <span class="nft-id">#${nft.tokenId}</span>
                                <a 
                                    href="https://opensea.io/assets/base/${NFT_CONTRACT}/${nft.tokenId}"
                                    target="_blank"
                                    class="nft-link"
                                >
                                    View on OpenSea ‚Üí
                                </a>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Gallery error:', error);
                galleryGrid.innerHTML = '<div class="empty-state"><p>Failed to load NFTs</p></div>';
            }
        }

        // Helpers
        function updateRequirement(id, met) {
            const el = document.getElementById(id);
            el.className = met ? 'check' : 'cross';
        }

        function showStatus(message, type) {
            mintStatus.innerHTML = `<div class="status-message ${type}">${message}</div>`;
        }

        function disconnectWallet() {
            provider = null;
            signer = null;
            userAddress = null;
            walletInfo.style.display = 'none';
            connectBtn.disabled = false;
            connectBtn.textContent = 'Connect Wallet';
            mintBtn.disabled = true;
            mintBtn.textContent = 'üéµ Mint NFT (Free)';
            mintBtn.classList.remove('success');
            mintStatus.innerHTML = '';
            galleryGrid.innerHTML = '<div class="empty-state"><p>Connect wallet to view your NFTs</p></div>';
            
            updateRequirement('req-wallet', false);
            updateRequirement('req-network', false);
            updateRequirement('req-proph', false);
        }

        // Listen for account/network changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }

        // Initial load
        loadGallery();
    </script>
</body>
</html>
